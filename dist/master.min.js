/**
 * @module cors
 * @author nuintun
 * @license MIT
 * @version 0.0.1
 * @description A pure JavaScript CORS framework.
 * @see https://nuintun.github.io/cors
 */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define("cors-master",e):t.CORSMaster=e()}(this,function(){"use strict";function t(){if(!document.body)return clearTimeout(u),u=setTimeout(t,1);for(var e=0;e<m.length;e++)m[e]();m=[]}function e(){document.removeEventListener("DOMContentLoaded",e,!1),t()}function n(){"complete"===document.readyState&&(document.detachEvent("onreadystatechange",n),t())}function r(){if(m.length>0){try{document.documentElement.doScroll("left")}catch(e){return setTimeout(r,1)}t()}}function o(o){m.push(o),"complete"===document.readyState?t():h||(!function(){if(f)document.addEventListener("DOMContentLoaded",e,!1),window.addEventListener("load",t,!1);else if(l){document.attachEvent("onreadystatechange",n),window.attachEvent("onload",t);var o=!1;try{o=null==window.frameElement}catch(i){}document.documentElement.doScroll&&o&&r()}}(),h=!0)}function i(t,e){return p+e+"-"+t+y}function a(t,e,n){return i(t,n)+JSON.stringify(e)+v}function s(t,e){this["<name>"]=String(t),this["<namespace>"]=String(e),this["<sources>"]={},this["<listeners>"]=[],this["<init>"]()}function c(t){t=String(t),this["<ready>"]=!1,this["<origin>"]=function(t){var e=b.exec(t);if(null===e)t=location.protocol+"//"+location.hostname+location.port;else{var n=e[1],r=e[2];t=(n||location.protocol)+"//"+r,"http"===n?t=t.replace(/:80$/,""):"https"===n&&(t=t.replace(/:443$/,""))}return t}(t),this["<callbacks>"]={ready:[]},this["<messenger>"]=this["<proxy>"](t)}var u,d=document.documentElement,l="attachEvent"in d,f="addEventListener"in d,h=!1,m=[],p="",y="",v="";s.prototype["<init>"]=function(){function t(t){var a=function(t,e){for(var n in e)if(e.hasOwnProperty(n)&&e[n]===t)return n;return null}(t.source,n);if(null!==a){var s=t.data;if(function(t,e,n){return 0===e.indexOf(i(t,n))&&e.lastIndexOf(v)===e.length-1}(e,s,r)){var c=t.origin;s=function(t,e,n){e=e.slice(i(t,n).length,-1);try{return JSON.parse(e)}catch(r){return e}}(e,s,r);for(var u=0,d=o.length;u<d;u++)o[u]({data:s,origin:c,source:a})}}}var e=this["<name>"],n=this["<sources>"],r=this["<namespace>"],o=this["<listeners>"];f?window.addEventListener("message",t,!1):l&&window.attachEvent("onmessage",t)},s.prototype.add=function(t,e){this["<sources>"][t]=e},s.prototype.onmessage=function(t){this["<listeners>"].push(t)},s.prototype.send=function(t,e,n){t=String(t);var r=this["<sources>"],o=this["<namespace>"];if("*"===t)for(t in r)r.hasOwnProperty(t)&&r[t].postMessage(a(t,e,o),n);else r.hasOwnProperty(t)&&r[t].postMessage(a(t,e,o),n)};var g=0,w=Object.prototype.toString,b=/^([a-z0-9.+-]+:)?\/\/(?:[^/:]*(?::[^/]*)?@)?([^/]+)/i;return c.prototype={"<onready>":function(t){var e=this["<callbacks>"];this["<ready>"]?t():e.ready.push(t)},"<proxy>":function(t){var e=document.createElement("iframe");e.setAttribute("width","0"),e.setAttribute("height","0"),e.setAttribute("frameborder","0"),e.setAttribute("marginwidth","0"),e.setAttribute("marginheight","0"),e.style.display="none",e.src=t;var n=this,r=n["<origin>"],i=n["<callbacks>"],a=new s("Master","CORS");return o(function(){document.body.appendChild(e),a.add("Worker",e.contentWindow),a.onmessage(function(t){if(t.origin===r){var e=t.data;if("ready"===e){if(!n["<ready>"]){n["<ready>"]=!0;for(var o=i.ready,a=0,s=o.length;a<s;a++)o[a]();delete i.ready}}else if("object"===function(t){return null===t?"null":void 0===t?"undefined":w.call(t).slice(8,-1).toLowerCase()}(e)){var c=e.uid;i[c]&&(i[c](e),delete i[c])}}})}),a},request:function(t,e){var n=this,r=n["<origin>"],o=n["<callbacks>"],i=n["<messenger>"];return new Promise(function(a,s){var c="UID-"+g++;o[c]=function(t){t.valid?a(t.data):s(t.data)},n["<onready>"](function(){i.send("Worker",{uid:c,url:t,options:e},r)})})}},c});
//# sourceMappingURL=master.js.map