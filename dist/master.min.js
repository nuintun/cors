/**
* @module cors
* @author nuintun
* @license MIT
* @version 0.0.1
* @description A pure JavaScript CORS framework.
* @see https://nuintun.github.io/cors
*/
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define("cors-master",e):t.CORSMaster=e()}(this,function(){"use strict";function t(){if(!document.body)return clearTimeout(f),f=setTimeout(t,1);for(var e=0;e<p.length;e++)p[e]();p=[]}function e(){document.removeEventListener("DOMContentLoaded",e,!1),t()}function n(){"complete"===document.readyState&&(document.detachEvent("onreadystatechange",n),t())}function i(){if(p.length>0){try{document.documentElement.doScroll("left")}catch(e){return setTimeout(i,1)}t()}}function o(t){var e=v.exec(t);if(null===e)t=location.protocol+"//"+location.hostname+location.port;else{var n=e[1],i=e[2];t=(n||location.protocol)+"//"+i,"http"===n?t=t.replace(/:80$/,""):"https"===n&&(t=t.replace(/:443$/,""))}return t}function r(t,e){return w+e+"-"+t+E}function a(t,e,n){return r(t,n)+e+b}function s(t,e,n){return t=S+"-"+n+"-"+t,"function"==typeof e&&(window.navigator[t]=e),window.navigator[t]}function c(t,e,n,i){this.name=String(t),this.target=e,this.origin=o(n),this.namespace=i}function d(t,e){this.name=String(t),this.namespace=arguments.length>1?String(e):"Messenger",this.targets={},this.listens=[],this.init()}function u(t){this["<ready>"]=!1,this["<origin>"]=o(t),this["<callbacks>"]={ready:[]},this["<messenger>"]=this["<proxy>"](t)}var f,h="attachEvent"in window,l="addEventListener"in window,m=!1,p=[],g=function(o){p.push(o),"complete"===document.readyState?t():m||(!function(){if(l)document.addEventListener("DOMContentLoaded",e,!1),window.addEventListener("load",t,!1);else if(h){document.attachEvent("onreadystatechange",n),window.attachEvent("onload",t);var o=!1;try{o=null==window.frameElement}catch(r){}document.documentElement.doScroll&&o&&i()}}(),m=!0)},y=0,v=/^([a-z0-9.+-]+:)?\/\/(?:[^/:]*(?::[^/]*)?@)?([^/]+)/i,w="",E="",b="",S="",O="postMessage"in window;return c.prototype.send=O?function(t,e){console.log(e,"------",this.origin),this.target.postMessage(a(this.name,t,this.namespace),e)}:function(t,e){if("*"===e||e===this.origin){var n=s(this.name,this.namespace);if("function"!=typeof n)throw new Error("Target callback function is not defined");n({origin:this.origin,data:a(t)})}},d.prototype.init=function(){function t(t){var o=t.data;if(function(t,e,n){return 0===e.indexOf(r(t,n))&&e.lastIndexOf(b)===e.length-1}(e,o,n)){var a=t.origin;o=function(t,e,n){return e.slice(r(t,n).length,-1)}(e,o,n);for(var s=0,c=i.length;s<c;s++)i[s](o,a)}}var e=this.name,n=this.namespace,i=this.listens;O?l?window.addEventListener("message",t,!1):h&&window.attachEvent("onmessage",t):s(e,t,n)},d.prototype.add=function(t,e,n){this.targets[t]=new c(t,e,n,this.namespace)},d.prototype.listen=function(t){this.listens.push(t)},d.prototype.clear=function(){this.listens=[]},d.prototype.send=function(t,e,n){var i=this.targets;if(arguments.length>1)e=String(e),i.hasOwnProperty(e)&&i[e].send(t,n);else for(var o in i)i.hasOwnProperty(o)&&i[o].send(t,n)},u.prototype={"<onready>":function(t){var e=this["<callbacks>"];this["<ready>"]?t():e.ready.push(t)},"<proxy>":function(t){var e=document.createElement("iframe");e.setAttribute("width","0"),e.setAttribute("height","0"),e.setAttribute("frameborder","0"),e.setAttribute("marginwidth","0"),e.setAttribute("marginheight","0"),e.src=t;var n=this,i=n["<callbacks>"],o=new d("Master");return g(function(){document.body.appendChild(e),o.add("Worker",e.contentWindow,e.src),o.listen(function(t,e){if("ready"===t){if(!n["<ready>"]){n["<ready>"]=!0;for(var o=i.ready,r=0,a=o.length;r<a;r++)o[r]();delete i.ready}}else{try{var s=JSON.parse(t)}catch(d){return console&&console.error&&console.error(t)}if(s){var c=s.uid;i[c]&&(i[c](s),delete i[c])}}})}),o},request:function(t,e){var n=this,i=n["<origin>"],o=n["<callbacks>"],r=n["<messenger>"];return new Promise(function(a,s){var c="UID-"+y++;o[c]=function(t){t.valid?a(t.data):s(t.data)},n["<onready>"](function(){r.send(JSON.stringify({uid:c,url:t,options:e}),"Worker",i)})})}},u});
//# sourceMappingURL=master.js.map