/**
 * @module cors
 * @author nuintun
 * @license MIT
 * @version 0.0.1
 * @description A pure JavaScript CORS framework.
 * @see https://nuintun.github.io/cors#readme
 */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define("cors-master",e):t.CORSMaster=e()}(this,function(){"use strict";var t,e=document.documentElement,n="attachEvent"in e,r="addEventListener"in e,o=!1,i=[];function a(){if(!document.body)return clearTimeout(t),t=setTimeout(a,1);for(var e=0;e<i.length;e++)i[e]();i=[]}function s(){document.removeEventListener("DOMContentLoaded",s,!1),a()}function c(){"complete"===document.readyState&&(document.detachEvent("onreadystatechange",c),a())}function d(){if(i.length>0){try{document.documentElement.doScroll("left")}catch(t){return setTimeout(d,1)}a()}}function u(t){i.push(t),"complete"===document.readyState?a():o||(!function(){if(r)document.addEventListener("DOMContentLoaded",s,!1),window.addEventListener("load",a,!1);else if(n){document.attachEvent("onreadystatechange",c),window.attachEvent("onload",a);var t=!1;try{t=null==window.frameElement}catch(e){}document.documentElement.doScroll&&t&&d()}}(),o=!0)}var l="",f="",h="";function m(t,e){return l+e+"-"+t+f}function p(t,e,n){return m(t,n)+JSON.stringify(e)+h}function v(t,e){this["<name>"]=String(t),this["<namespace>"]=String(e),this["<sources>"]={},this["<listeners>"]=[],this["<init>"]()}v.prototype["<init>"]=function(){var t=this["<name>"],e=this["<sources>"],o=this["<namespace>"],i=this["<listeners>"];function a(n){var r=function(t,e){for(var n in e)if(e.hasOwnProperty(n)&&e[n]===t)return n;return null}(n.source,e);if(null!==r){var a=n.data;if(function(t,e,n){return 0===e.indexOf(m(t,n))&&e.lastIndexOf(h)===e.length-1}(t,a,o)){var s=n.origin;a=function(t,e,n){e=e.slice(m(t,n).length,-1);try{return JSON.parse(e)}catch(r){return e}}(t,a,o);for(var c=0,d=i.length;c<d;c++)i[c]({data:a,origin:s,source:r})}}}r?window.addEventListener("message",a,!1):n&&window.attachEvent("onmessage",a)},v.prototype.add=function(t,e){this["<sources>"][t]=e},v.prototype.onmessage=function(t){this["<listeners>"].push(t)},v.prototype.send=function(t,e,n){t=String(t);var r=this["<sources>"],o=this["<namespace>"];if("*"===t)for(t in r)r.hasOwnProperty(t)&&r[t].postMessage(p(t,e,o),n);else r.hasOwnProperty(t)&&r[t].postMessage(p(t,e,o),n)};var y=0;var g=Object.prototype.toString;var w=/^([a-z0-9.+-]+:)?\/\/(?:[^/:]*(?::[^/]*)?@)?([^/]+)/i;function b(t){t=String(t),this["<ready>"]=!1,this["<origin>"]=function(t){var e=w.exec(t);if(null===e)t=location.protocol+"//"+location.hostname+location.port;else{var n=e[1],r=e[2];t=(n||location.protocol)+"//"+r,"http"===n?t=t.replace(/:80$/,""):"https"===n&&(t=t.replace(/:443$/,""))}return t}(t),this["<callbacks>"]={ready:[]},this["<messenger>"]=this["<proxy>"](t)}return b.prototype={"<onready>":function(t){var e=this["<callbacks>"];this["<ready>"]?t():e.ready.push(t)},"<proxy>":function(t){var e=document.createElement("iframe");e.setAttribute("width","0"),e.setAttribute("height","0"),e.setAttribute("frameborder","0"),e.setAttribute("marginwidth","0"),e.setAttribute("marginheight","0"),e.style.display="none",e.src=t;var n=this,r=n["<origin>"],o=n["<callbacks>"],i=new v("Master","CORS");return u(function(){document.body.appendChild(e),i.add("Worker",e.contentWindow),i.onmessage(function(t){if(t.origin===r){var e=t.data;if("ready"===e){if(!n["<ready>"]){n["<ready>"]=!0;for(var i=o.ready,a=0,s=i.length;a<s;a++)i[a]();delete o.ready}}else if("object"===(null===(d=e)?"null":void 0===d?"undefined":g.call(d).slice(8,-1).toLowerCase())){var c=e.uid;o[c]&&(o[c](e),delete o[c])}}var d})}),i},request:function(t,e){var n=this,r=n["<origin>"],o=n["<callbacks>"],i=n["<messenger>"];return new Promise(function(a,s){var c="UID-"+y++;o[c]=function(t){t.valid?a(t.data):s(t.data)},n["<onready>"](function(){i.send("Worker",{uid:c,url:t,options:e},r)})})}},b});
//# sourceMappingURL=master.js.map