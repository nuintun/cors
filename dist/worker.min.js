/**
 * @module cors
 * @author nuintun
 * @license MIT
 * @version 0.0.1
 * @description A pure JavaScript CORS framework.
 * @see https://nuintun.github.io/cors#readme
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define("cors-worker",t):e.CORSWorker=t()}(this,function(){"use strict";var e=Object.prototype.toString;function t(t){return null===t?"null":void 0===t?"undefined":e.call(t).slice(8,-1).toLowerCase()}var n=Array.isArray?function(e){return Array.isArray(e)}:function(e){return"array"===t(e)},r=/^([a-z0-9.+-]+:)?\/\/(?:[^/:]*(?::[^/]*)?@)?([^/]+)/i;function o(e,r,a){if(n(r))for(var i,s=0,u=r.length;s<u;s++)o(e+"["+("object"===t(i=r[s])&&null!=i?s:"")+"]",i,a);else if("object"===t(r))for(var c in r)o(e+"["+c+"]",r[c],a);else a(e,r)}var a=0,i=/\?/,s=encodeURIComponent("Â‘"),u=["DELETE","GET","HEAD","OPTIONS","POST","PUT"];function c(e){e.onreadystatechange=null,e.onerror=null,e.ontimeout=null,e.onabort=null}function d(e,r){var d,f;return(r=r||{}).cache=!1!==r.cache,r.headers=r.headers||{},r.data=r.hasOwnProperty("data")?function(e){var r=[];function a(e,t){t="function"==typeof t?t():t,r[r.length]=encodeURIComponent(e)+"="+encodeURIComponent(null==t?"":t)}if(n(e))for(var i,s=0,u=e.length;s<u;s++)a((i=e[s]).name,i.value);else{if("object"!==t(e))return String(e);for(var c in e)o(c,e[c],a)}return r.join("&")}(r.data):null,r.method=r.hasOwnProperty("method")?(d=r.method,f=(d=String(d)).toUpperCase(),u.indexOf(f)>-1?f:d):"GET","GET"===r.method&&(null!==r.data&&(e+=i.test(e)?"&"+r.data:"?"+r.data),r.cache&&(e+=(i.test(e)?"&":"?")+s+"="+(+new Date+a++))),new Promise(function(t,n){var o=new XMLHttpRequest;function a(t){n(new TypeError("Request "+e+" "+t))}o.onreadystatechange=function(){4===o.readyState&&(c(o),t(o))},o.ontimeout=function(){c(o),a("timeout")},o.onabort=function(){c(o),a("aborted")},o.onerror=function(){c(o),a("failed")},o.open(r.method,e,!0,r.username,r.password);var i=r.headers;for(var s in i)i.hasOwnProperty(s)&&o.setRequestHeader(s,String(i[s]));o.setRequestHeader("X-Requested-With","XMLHttpRequest"),"POST"===r.method&&o.setRequestHeader("Content-Type","application/x-www-form-urlencoded;charset=UTF-8"),o.send("POST"===r.method?r.data:null)})}var f=document.documentElement,l="attachEvent"in f,p="addEventListener"in f,h="",m="",v="";function y(e,t){return h+t+"-"+e+m}function g(e,t,n){return y(e,n)+JSON.stringify(t)+v}function w(e,t){this["<name>"]=String(e),this["<namespace>"]=String(t),this["<sources>"]={},this["<listeners>"]=[],this["<init>"]()}function O(){this["<init>"]()}return w.prototype["<init>"]=function(){var e=this["<name>"],t=this["<sources>"],n=this["<namespace>"],r=this["<listeners>"];function o(o){var a=function(e,t){for(var n in t)if(t.hasOwnProperty(n)&&t[n]===e)return n;return null}(o.source,t);if(null!==a){var i=o.data;if(function(e,t,n){return 0===t.indexOf(y(e,n))&&t.lastIndexOf(v)===t.length-1}(e,i,n)){var s=o.origin;i=function(e,t,n){t=t.slice(y(e,n).length,-1);try{return JSON.parse(t)}catch(r){return t}}(e,i,n);for(var u=0,c=r.length;u<c;u++)r[u]({data:i,origin:s,source:a})}}}p?window.addEventListener("message",o,!1):l&&window.attachEvent("onmessage",o)},w.prototype.add=function(e,t){this["<sources>"][e]=t},w.prototype.onmessage=function(e){this["<listeners>"].push(e)},w.prototype.send=function(e,t,n){e=String(e);var r=this["<sources>"],o=this["<namespace>"];if("*"===e)for(e in r)r.hasOwnProperty(e)&&r[e].postMessage(g(e,t,o),n);else r.hasOwnProperty(e)&&r[e].postMessage(g(e,t,o),n)},O.prototype["<init>"]=function(){var e=new w("Worker","CORS");e.add("Master",window.parent),e.onmessage(function(t){var n=t.data,r=t.origin,o=t.source;d(n.url,n.options).then(function(t){e.send(o,{valid:!0,uid:n.uid,data:t.responseText},r)})["catch"](function(t){e.send(o,{valid:!1,uid:n.uid,data:t.stack||t.message},r)})}),e.send("Master","ready",function(e){var t=r.exec(e);if(null===t)e=location.protocol+"//"+location.hostname+location.port;else{var n=t[1],o=t[2];e=(n||location.protocol)+"//"+o,"http"===n?e=e.replace(/:80$/,""):"https"===n&&(e=e.replace(/:443$/,""))}return e}(document.referrer))},O});
//# sourceMappingURL=worker.js.map